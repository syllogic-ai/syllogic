# ──────────────────────────────────────────────────────────────
# Syllogic — Railway Docker Compose
# ──────────────────────────────────────────────────────────────
#
# Drag this file onto your Railway project canvas to import all
# services. Then follow the post-import steps in the README.
#
# IMPORTANT: This file is wired for Railway Shared Variables.
# Set the required shared values once in Railway and services
# will resolve them automatically via ${{shared.VAR}} references.
#
# What's different from the self-hosted compose:
#   - No Caddy (Railway provides reverse proxy + TLS)
#   - No uploads-init (Railway volumes are writable)
#   - No migrate service (app runs migrations before start)
#   - No depends_on (Railway deploys services independently)
#   - No container_name (Railway manages names)
#   - No bind mounts (no host filesystem on Railway)
#
# Railway-specific (baked into this compose):
#   - app PORT is pinned to 3000 (Railway proxy expects this)
#   - backend PORT is pinned to 8080 so app BACKEND_URL can reference backend.PORT
#   - App runs as root on Railway so mounted upload volumes are writable on first boot
#   - App startup command runs DB migrations before Next.js boot
# ──────────────────────────────────────────────────────────────

services:
  # ── Database ──────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: financeuser
      POSTGRES_PASSWORD: ${{shared.POSTGRES_PASSWORD}}
      POSTGRES_DB: finance_db
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U financeuser -d finance_db"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  # ── Cache / Message Broker ────────────────────────────────
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: always

  # ── Backend API (FastAPI) ─────────────────────────────────
  backend:
    # Template maintainers: replace :edge with a pinned release tag for production templates.
    image: ghcr.io/syllogic-ai/personal-finance-backend:edge
    environment:
      NODE_ENV: production
      PORT: "8080"
      DATABASE_URL: postgresql://financeuser:${{shared.POSTGRES_PASSWORD}}@${{postgres.RAILWAY_PRIVATE_DOMAIN}}:5432/finance_db?sslmode=require
      REDIS_URL: redis://${{redis.RAILWAY_PRIVATE_DOMAIN}}:6379/0
      FRONTEND_URL: ${{app.RAILWAY_STATIC_URL}}
      CORS_ALLOW_ORIGINS: ${{app.RAILWAY_STATIC_URL}}
      API_DOCS_ENABLED: "false"
      INTERNAL_AUTH_SECRET: ${{shared.INTERNAL_AUTH_SECRET}}
      DATA_ENCRYPTION_KEY_CURRENT: ${{shared.DATA_ENCRYPTION_KEY_CURRENT}}
      DATA_ENCRYPTION_KEY_PREVIOUS: ${{shared.DATA_ENCRYPTION_KEY_PREVIOUS}}
      DATA_ENCRYPTION_KEY_ID: ${{shared.DATA_ENCRYPTION_KEY_ID}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── MCP Server (FastMCP) ──────────────────────────────────
  mcp:
    image: ghcr.io/syllogic-ai/personal-finance-backend:edge
    command: uvicorn mcp_server:app --host 0.0.0.0 --port 8001
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request,sys; r=urllib.request.urlopen('http://127.0.0.1:8001/health'); sys.exit(0 if r.status==200 else 1)\"",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
    environment:
      NODE_ENV: production
      PROCESS_TYPE: mcp
      PORT: "8001"
      DATABASE_URL: postgresql://financeuser:${{shared.POSTGRES_PASSWORD}}@${{postgres.RAILWAY_PRIVATE_DOMAIN}}:5432/finance_db?sslmode=require
      DATA_ENCRYPTION_KEY_CURRENT: ${{shared.DATA_ENCRYPTION_KEY_CURRENT}}
      DATA_ENCRYPTION_KEY_PREVIOUS: ${{shared.DATA_ENCRYPTION_KEY_PREVIOUS}}
      DATA_ENCRYPTION_KEY_ID: ${{shared.DATA_ENCRYPTION_KEY_ID}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Celery Worker ─────────────────────────────────────────
  worker:
    image: ghcr.io/syllogic-ai/personal-finance-backend:edge
    command: celery -A celery_app worker --loglevel=info --concurrency=4
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://financeuser:${{shared.POSTGRES_PASSWORD}}@${{postgres.RAILWAY_PRIVATE_DOMAIN}}:5432/finance_db?sslmode=require
      REDIS_URL: redis://${{redis.RAILWAY_PRIVATE_DOMAIN}}:6379/0
      FRONTEND_URL: ${{app.RAILWAY_STATIC_URL}}
      CORS_ALLOW_ORIGINS: ${{app.RAILWAY_STATIC_URL}}
      API_DOCS_ENABLED: "false"
      DATA_ENCRYPTION_KEY_CURRENT: ${{shared.DATA_ENCRYPTION_KEY_CURRENT}}
      DATA_ENCRYPTION_KEY_PREVIOUS: ${{shared.DATA_ENCRYPTION_KEY_PREVIOUS}}
      DATA_ENCRYPTION_KEY_ID: ${{shared.DATA_ENCRYPTION_KEY_ID}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Celery Beat (scheduler) ───────────────────────────────
  beat:
    image: ghcr.io/syllogic-ai/personal-finance-backend:edge
    command: celery -A celery_app beat --loglevel=info
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://financeuser:${{shared.POSTGRES_PASSWORD}}@${{postgres.RAILWAY_PRIVATE_DOMAIN}}:5432/finance_db?sslmode=require
      REDIS_URL: redis://${{redis.RAILWAY_PRIVATE_DOMAIN}}:6379/0
      FRONTEND_URL: ${{app.RAILWAY_STATIC_URL}}
      CORS_ALLOW_ORIGINS: ${{app.RAILWAY_STATIC_URL}}
      API_DOCS_ENABLED: "false"
      DATA_ENCRYPTION_KEY_CURRENT: ${{shared.DATA_ENCRYPTION_KEY_CURRENT}}
      DATA_ENCRYPTION_KEY_PREVIOUS: ${{shared.DATA_ENCRYPTION_KEY_PREVIOUS}}
      DATA_ENCRYPTION_KEY_ID: ${{shared.DATA_ENCRYPTION_KEY_ID}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Frontend (Next.js) ────────────────────────────────────
  # Migrations run automatically at startup before Next.js boot.
  # Keep PORT=3000 so Railway proxy routes traffic correctly.
  app:
    image: ghcr.io/syllogic-ai/personal-finance-frontend:edge
    command: /bin/sh -lc "mkdir -p /app/public/uploads/profile /app/public/uploads/logos /app/public/uploads/imports && chmod -R u+rwX,g+rwX /app/public/uploads && node scripts/migrate.js && exec node_modules/.bin/next start -p 3000 -H 0.0.0.0"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "test -w /app/public/uploads && node -e \"require('http').get('http://127.0.0.1:3000/', (r)=>process.exit(r.statusCode && r.statusCode < 500 ? 0 : 1)).on('error', ()=>process.exit(1))\"",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
    environment:
      NODE_ENV: production
      PORT: "3000"
      RAILWAY_RUN_UID: "0"
      DATABASE_URL: postgresql://financeuser:${{shared.POSTGRES_PASSWORD}}@${{postgres.RAILWAY_PRIVATE_DOMAIN}}:5432/finance_db?sslmode=require
      APP_URL: ${{app.RAILWAY_STATIC_URL}}
      BETTER_AUTH_URL: ${{app.RAILWAY_STATIC_URL}}
      NEXT_PUBLIC_BETTER_AUTH_URL: ${{app.RAILWAY_STATIC_URL}}
      BETTER_AUTH_SECRET: ${{shared.BETTER_AUTH_SECRET}}
      INTERNAL_AUTH_SECRET: ${{shared.INTERNAL_AUTH_SECRET}}
      DATA_ENCRYPTION_KEY_CURRENT: ${{shared.DATA_ENCRYPTION_KEY_CURRENT}}
      DATA_ENCRYPTION_KEY_PREVIOUS: ${{shared.DATA_ENCRYPTION_KEY_PREVIOUS}}
      DATA_ENCRYPTION_KEY_ID: ${{shared.DATA_ENCRYPTION_KEY_ID}}
      BACKEND_URL: http://${{backend.RAILWAY_PRIVATE_DOMAIN}}:${{backend.PORT}}
      STORAGE_PROVIDER: local
      LOCAL_STORAGE_PATH: uploads
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
      LOGO_DEV_API_KEY: ${{shared.LOGO_DEV_API_KEY}}
    volumes:
      # Persist uploaded files and keep them directly web-accessible at /uploads/*
      - uploads_data:/app/public/uploads
    restart: always

volumes:
  postgres_data:
  redis_data:
  uploads_data:
