name: syllogic

services:
  postgres:
    image: postgres:16-alpine
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      POSTGRES_USER: ${POSTGRES_USER:-financeuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-financepass}
      POSTGRES_DB: ${POSTGRES_DB:-finance_db}
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/postgres
        target: /var/lib/postgresql/data
    restart: unless-stopped
    x-casaos:
      envs:
        - container: POSTGRES_USER
          description:
            en_US: Database username.
        - container: POSTGRES_PASSWORD
          description:
            en_US: Database password (required).
        - container: POSTGRES_DB
          description:
            en_US: Database name.
        - container: PUID
          description:
            en_US: Run the app as this user ID.
        - container: PGID
          description:
            en_US: Run the app as this group ID.
        - container: TZ
          description:
            en_US: Timezone (e.g. Europe/Athens).
      volumes:
        - container: /var/lib/postgresql/data
          description:
            en_US: Postgres database data.

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/redis
        target: /data
    restart: unless-stopped
    x-casaos:
      volumes:
        - container: /data
          description:
            en_US: Redis data.

  uploads-init:
    image: alpine:3.20
    command: ["sh", "-c", "mkdir -p /uploads && chown -R ${PUID:-1000}:${PGID:-1000} /uploads"]
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/uploads
        target: /uploads
    restart: "no"

  migrate:
    image: ghcr.io/syllogic-ai/personal-finance-frontend:${APP_VERSION:-edge}
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
    depends_on:
      - postgres
    command: ["node", "scripts/migrate.js"]
    restart: "no"

  backend:
    image: ghcr.io/syllogic-ai/personal-finance-backend:${APP_VERSION:-edge}
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      FRONTEND_URL: ${APP_URL:-http://localhost:8080}
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-${APP_URL:-http://localhost:8080}}
      API_DOCS_ENABLED: ${API_DOCS_ENABLED:-false}
      INTERNAL_AUTH_SECRET: ${INTERNAL_AUTH_SECRET:-change-me}
      # Optional integrations / features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_PRIVATE_KEY: ${KRAKEN_PRIVATE_KEY:-}
    depends_on:
      - postgres
      - redis
      - migrate
    restart: unless-stopped
    x-casaos:
      envs:
        - container: FRONTEND_URL
          description:
            en_US: Frontend URL for CORS and SSE.
        - container: CORS_ALLOW_ORIGINS
          description:
            en_US: Comma-separated allowed origins.
        - container: API_DOCS_ENABLED
          description:
            en_US: Enable FastAPI docs (true/false).
        - container: INTERNAL_AUTH_SECRET
          description:
            en_US: Shared secret used for internal signed API requests.
        - container: OPENAI_API_KEY
          description:
            en_US: OpenAI API key (optional).

  mcp:
    image: ghcr.io/syllogic-ai/personal-finance-backend:${APP_VERSION:-edge}
    command: uvicorn mcp_server:app --host 0.0.0.0 --port 8001
    environment:
      PROCESS_TYPE: mcp
      PORT: "8001"
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
      # Optional integrations / features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_PRIVATE_KEY: ${KRAKEN_PRIVATE_KEY:-}
    depends_on:
      - postgres
      - migrate
    ports:
      - target: 8001
        published: ${MCP_PORT:-8001}
        protocol: tcp
    restart: unless-stopped
    x-casaos:
      ports:
        - container: "8001"
          description:
            en_US: MCP external port (maps to internal 8001).

  worker:
    image: ghcr.io/syllogic-ai/personal-finance-backend:${APP_VERSION:-edge}
    command: celery -A celery_app worker --loglevel=info --concurrency=4
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      # Optional integrations / features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_PRIVATE_KEY: ${KRAKEN_PRIVATE_KEY:-}
    depends_on:
      - postgres
      - redis
      - migrate
    restart: unless-stopped

  beat:
    image: ghcr.io/syllogic-ai/personal-finance-backend:${APP_VERSION:-edge}
    command: celery -A celery_app beat --loglevel=info
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      # Optional integrations / features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_PRIVATE_KEY: ${KRAKEN_PRIVATE_KEY:-}
    depends_on:
      - postgres
      - redis
      - migrate
    restart: unless-stopped

  app:
    image: ghcr.io/syllogic-ai/personal-finance-frontend:${APP_VERSION:-edge}
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-UTC}
      NODE_ENV: production
      APP_URL: ${APP_URL:-http://localhost:8080}
      DATABASE_URL: postgresql://${POSTGRES_USER:-financeuser}:${POSTGRES_PASSWORD:-financepass}@postgres:5432/${POSTGRES_DB:-finance_db}
      BETTER_AUTH_URL: ${APP_URL:-http://localhost:8080}
      NEXT_PUBLIC_BETTER_AUTH_URL: ${APP_URL:-http://localhost:8080}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-change-me}
      INTERNAL_AUTH_SECRET: ${INTERNAL_AUTH_SECRET:-change-me}
      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
      LOCAL_STORAGE_PATH: ${LOCAL_STORAGE_PATH:-uploads}
      # Optional features
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LOGO_DEV_API_KEY: ${LOGO_DEV_API_KEY:-}
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/uploads
        target: /app/public/uploads
    depends_on:
      - uploads-init
      - migrate
    restart: unless-stopped
    x-casaos:
      envs:
        - container: APP_URL
          description:
            en_US: Public URL where you access Syllogic.
        - container: BETTER_AUTH_SECRET
          description:
            en_US: Secret used to sign auth sessions (required).
        - container: BACKEND_URL
          description:
            en_US: Backend internal URL (default uses Docker network).
        - container: INTERNAL_AUTH_SECRET
          description:
            en_US: Shared secret used for internal signed API requests.
        - container: STORAGE_PROVIDER
          description:
            en_US: Storage provider (local).
        - container: LOCAL_STORAGE_PATH
          description:
            en_US: Local uploads directory in container.
        - container: OPENAI_API_KEY
          description:
            en_US: OpenAI API key (optional).
        - container: LOGO_DEV_API_KEY
          description:
            en_US: Logo.dev API key (optional).
        - container: PUID
          description:
            en_US: Run the app as this user ID.
        - container: PGID
          description:
            en_US: Run the app as this group ID.
        - container: TZ
          description:
            en_US: Timezone (e.g. Europe/Athens).
      volumes:
        - container: /app/public/uploads
          description:
            en_US: User uploads and CSV storage.

  # CasaOS typically runs on a local network; default to HTTP-only via Caddy.
  caddy:
    image: caddy:2-alpine
    ports:
      - target: 80
        published: ${WEBUI_PORT:-8080}
        protocol: tcp
    environment:
      CADDY_ADDRESS: ":80"
    command:
      - sh
      - -c
      - |
          if [ ! -s /etc/caddy/Caddyfile ]; then
            cat > /etc/caddy/Caddyfile <<'EOF'
          {$CADDY_ADDRESS} {
          	encode zstd gzip

          	@auth path /api/auth/*
          	reverse_proxy @auth app:3000

          	@health path /api/health
          	reverse_proxy @health backend:8000

          	@api path /api/*
          	reverse_proxy @api app:3000

          	reverse_proxy app:3000
          }
          EOF
          fi
          caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/caddy
        target: /etc/caddy
      - type: bind
        source: /DATA/AppData/$AppID/caddy/data
        target: /data
      - type: bind
        source: /DATA/AppData/$AppID/caddy/config
        target: /config
    depends_on:
      - app
      - backend
    restart: unless-stopped
    x-casaos:
      ports:
        - container: "80"
          description:
            en_US: Web UI HTTP port.
      volumes:
        - container: /etc/caddy
          description:
            en_US: Caddy configuration (Caddyfile).
        - container: /data
          description:
            en_US: Caddy TLS data.
        - container: /config
          description:
            en_US: Caddy config data.

x-casaos:
  architectures:
    - amd64
    - arm64
  main: caddy
  port_map: "${WEBUI_PORT:-8080}"
  title:
    en_US: Syllogic
  description:
    en_US: Self-hosted personal finance management with a Next.js UI, FastAPI backend, and Postgres.
  tagline:
    en_US: Track spending, imports, balances, and analytics.
  developer: syllogic-ai
  author: syllogic-ai
  category: Finance
  website: https://github.com/syllogic-ai/personal-finance-app
  index: /
  tips:
    before_install:
      en_US: |
        Set BETTER_AUTH_SECRET, INTERNAL_AUTH_SECRET, and POSTGRES_PASSWORD before installing.
        The app will be available on http://<CasaOS-IP>:${WEBUI_PORT:-8080}
