# ──────────────────────────────────────────────────────────────
# Syllogic — Railway Docker Compose
# ──────────────────────────────────────────────────────────────
#
# Drag this file onto your Railway project canvas to import all
# services. Then follow the post-import steps in the README.
#
# IMPORTANT: This file is wired for Railway Shared Variables.
# Set the required shared values once in Railway and services
# will resolve them automatically via ${{shared.VAR}} references.
#
# What's different from the self-hosted compose:
#   - No Caddy (Railway provides reverse proxy + TLS)
#   - No uploads-init (Railway volumes are writable)
#   - No migrate service (app runs migrations before start)
#   - No depends_on (Railway deploys services independently)
#   - No container_name (Railway manages names)
#   - No bind mounts (no host filesystem on Railway)
#
# Railway-specific (set in dashboard or after import):
#   - app: PORT=3000 (Railway proxy expects this)
#   - Backend listens on Railway PORT (default 8080); use :8080 in BACKEND_URL
#   - App runs as root on Railway so mounted upload volumes are writable on first boot
#   - App startup command runs DB migrations before Next.js boot
# ──────────────────────────────────────────────────────────────

services:
  # ── Database ──────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: financeuser
      POSTGRES_PASSWORD: ${{shared.POSTGRES_PASSWORD}}
      POSTGRES_DB: finance_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  # ── Cache / Message Broker ────────────────────────────────
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: always

  # ── Backend API (FastAPI) ─────────────────────────────────
  backend:
    image: ghcr.io/syllogic-ai/personal-finance-backend:sha-d8236be
    environment:
      DATABASE_URL: ${{shared.DATABASE_URL}}
      REDIS_URL: ${{shared.REDIS_URL}}
      FRONTEND_URL: ${{shared.APP_URL}}
      CORS_ALLOW_ORIGINS: ${{shared.APP_URL}}
      API_DOCS_ENABLED: "false"
      INTERNAL_AUTH_SECRET: ${{shared.INTERNAL_AUTH_SECRET}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── MCP Server (FastMCP) ──────────────────────────────────
  mcp:
    image: ghcr.io/syllogic-ai/personal-finance-backend:sha-d8236be
    command: uvicorn mcp_server:app --host 0.0.0.0 --port 8001
    environment:
      DATABASE_URL: ${{shared.DATABASE_URL}}
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Celery Worker ─────────────────────────────────────────
  worker:
    image: ghcr.io/syllogic-ai/personal-finance-backend:sha-d8236be
    command: celery -A celery_app worker --loglevel=info --concurrency=4
    environment:
      DATABASE_URL: ${{shared.DATABASE_URL}}
      REDIS_URL: ${{shared.REDIS_URL}}
      FRONTEND_URL: ${{shared.APP_URL}}
      CORS_ALLOW_ORIGINS: ${{shared.APP_URL}}
      API_DOCS_ENABLED: "false"
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Celery Beat (scheduler) ───────────────────────────────
  beat:
    image: ghcr.io/syllogic-ai/personal-finance-backend:sha-d8236be
    command: celery -A celery_app beat --loglevel=info
    environment:
      DATABASE_URL: ${{shared.DATABASE_URL}}
      REDIS_URL: ${{shared.REDIS_URL}}
      FRONTEND_URL: ${{shared.APP_URL}}
      CORS_ALLOW_ORIGINS: ${{shared.APP_URL}}
      API_DOCS_ENABLED: "false"
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
    restart: always

  # ── Frontend (Next.js) ────────────────────────────────────
  # Migrations run automatically at startup before Next.js boot.
  # Keep PORT=3000 so Railway proxy routes traffic correctly.
  app:
    image: ghcr.io/syllogic-ai/personal-finance-frontend:sha-d8236be
    command:
      - /bin/sh
      - -lc
      - mkdir -p /app/public/uploads && node scripts/migrate.js && exec node_modules/.bin/next start -p 3000 -H 0.0.0.0
    environment:
      NODE_ENV: production
      PORT: "3000"
      RAILWAY_RUN_UID: "0"
      DATABASE_URL: ${{shared.DATABASE_URL}}
      APP_URL: ${{shared.APP_URL}}
      BETTER_AUTH_URL: ${{shared.APP_URL}}
      NEXT_PUBLIC_BETTER_AUTH_URL: ${{shared.APP_URL}}
      BETTER_AUTH_SECRET: ${{shared.BETTER_AUTH_SECRET}}
      INTERNAL_AUTH_SECRET: ${{shared.INTERNAL_AUTH_SECRET}}
      BACKEND_URL: ${{shared.BACKEND_URL}}
      STORAGE_PROVIDER: local
      LOCAL_STORAGE_PATH: uploads
      OPENAI_API_KEY: ${{shared.OPENAI_API_KEY}}
      LOGO_DEV_API_KEY: ${{shared.LOGO_DEV_API_KEY}}
    volumes:
      # Persist uploaded files and keep them directly web-accessible at /uploads/*
      - uploads_data:/app/public/uploads
    restart: always

volumes:
  postgres_data:
  redis_data:
  uploads_data:
